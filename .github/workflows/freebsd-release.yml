# .github/workflows/freebsd-release.yml

name: Build and Release for FreeBSD

# 触发条件：支持三种方式
on:
  # 1. 当推送一个以 'v' 开头的 tag 时触发 (用于正式发布)
  push:
    tags:
      - 'v*'

  # 2. 当推送到 main 分支时触发 (用于持续集成)
  push:
    branches:
      - 'main' # 或者你的主分支名，如 'master'

  # 3. 手动触发 (用于测试或临时构建)
  workflow_dispatch:

jobs:
  build:
    name: Build Go Binary for FreeBSD
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Build Frontend
        run: |
          cd web
          bun install
          bun run build
          
      - name: Build Go binary for FreeBSD
        run: |
          export GOOS=freebsd
          export GOARCH=amd64
          export CGO_ENABLED=0
          go build -ldflags "-s -w" -o new-api-freebsd-amd64 main.go

      # --- 步骤 A: 上传到 GitHub Release (仅在 Tag 触发时执行) ---
      - name: Upload Release Asset
        # 这个 if 条件是关键！它确保该步骤仅在推送 tag 时运行
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            new-api-freebsd-amd64

      # --- 步骤 B: 上传为 Build Artifact (在手动触发或分支推送时执行) ---
      - name: Upload Build Artifact
        # 这个 if 条件确保该步骤在非 tag 触发时运行
        if: !startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: freebsd-amd64-binary
          path: new-api-freebsd-amd64
          retention-days: 7 # 临时构建，保留7天就够了
