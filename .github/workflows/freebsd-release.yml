# .github/workflows/build-freebsd.yml

name: Build for FreeBSD

# 手动触发
on:
  workflow_dispatch:
    inputs:
      go_version:
        description: 'Go version to use'
        required: true
        default: '1.21.6'
        type: string
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build FreeBSD Binary
    # 使用最新的 Ubuntu 环境作为构建环境
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. 设置 Go 环境
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # 使用输入框指定的 Go 版本，默认为 1.21.6
          go-version: ${{ inputs.go_version }}
          # 启用依赖缓存，加速构建
          cache: true

      # 3. 设置 Bun 环境 (用于前端构建)
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest # 使用最新版本的 Bun

      # 4. 构建前端资源 (必须在 Go 构建之前)
      - name: Build Frontend Assets
        run: |
          echo "Building frontend..."
          cd web
          bun install
          bun run build
          echo "Frontend build completed."

      # 5. 交叉编译 Go 后端到 FreeBSD
      - name: Build Go Backend for FreeBSD
        run: |
          echo "Cross-compiling Go for FreeBSD/amd64..."
          # 下载 Go 依赖
          go mod download
          
          # 设置目标操作系统和架构
          # GOOS: freebsd
          # GOARCH: amd64 (最常用的 FreeBSD 架构)
          # -ldflags "-s -w": 减小二进制文件体积
          # -o: 指定输出文件名
          GOOS=freebsd GOARCH=amd64 go build -ldflags "-s -w" -o new-api-freebsd-amd64
          
          echo "Go binary for FreeBSD created: new-api-freebsd-amd64"

      # 6. 上传构建产物
      - name: Upload FreeBSD Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          # 产物的名称
          name: freebsd-amd64-binary
          # 要上传的文件路径
          path: new-api-freebsd-amd64
          # 产物的保留天数 (可选)
          retention-days: 30
